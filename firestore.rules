rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // match /{document=**} {
    //   allow read: if true;
    // }
    // Users
    match /users/{userId} {
     function leagueId() {
    	return request.resource.data.leagues.keys();
    }
      allow read: if request.auth != null;
      allow create: if request.auth != null;
     // allow update: if request.auth != null && request.auth.uid == userId;
      // allow league admins and club manager to make updates
      allow update: if request.auth != null 
    //  && request.resource.data.leagues.keys() != []
    //  &&  resource.data.leagues.keys().hasAll(leagueId());
     //FIXME && (request.resource.data.leagues.diff(resource.data.leagues).affectedKeys()
      //  .hasAll(leagueId()));
    }

  // League
    match /leagues/{leagueId} {
      function isAdmin() {
        return request.auth != null && get(/databases/$(database)/documents/leagues/$(leagueId)).data.adminId == request.auth.uid;
    }

    function isNotScheduled() {
      return get(/databases/$(database)/documents/leagues/$(leagueId)).data.scheduled == false
    }
      allow read: if true;
      allow create: if request.auth != null;
      allow update, delete: if isAdmin();
      allow update: if request.auth != null && (request.resource.data.diff(resource.data).affectedKeys()
        .hasOnly(['acceptedClubs']));
      // Club
      match /clubs/{clubId} {
        allow read: if true;
        allow create: if request.auth != null && isNotScheduled()
        allow update: if request.auth != null && request.auth.uid == resource.data.managerId || isAdmin()
        allow delete: if request.auth != null && request.auth.uid == resource.data.managerId && isNotScheduled()
        allow delete: if isAdmin() && isNotScheduled()
        // allow player to create entry in the club's roster
        allow update: if request.auth != null && (request.resource.data.diff(resource.data).affectedKeys()
        .hasOnly(['roster']));
      }
      // Standings
      match /stats/standings {
        allow write: if false;
        allow read: if request.auth != null;
      }
      // Player Total Stats
      match /stats/players {
        allow write: if request.auth != null;
         allow read: if request.auth != null;
      }
      // Player Match Stats
      match /stats/players/playerMatches/{matchId} {
        allow write: if request.auth != null;
         allow read: if request.auth != null;
      }
      // Matches
      match /matches/{matchId} {
        allow read: if request.auth != null ;
        allow update: if request.auth != null 
//        && resource.data.published == false 
        && resource.data.conflict == false 
        // && (request.resource.data.diff(resource.data).affectedKeys()
        // .hasOnly(['submissions', 'players', 'motmSubmissions']))
      }
    }
  }
}